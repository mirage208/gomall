# 用户服务 (User Service)

## 1. 服务概述

用户服务是 GoMall 电商系统的核心基础服务之一，负责用户的注册、登录、信息管理等功能。

## 2. 数据模型

### 2.1 用户表 (user)

| 字段名      | 类型            | 长度 | 非空 | 默认值            | 说明                          |
| ----------- | --------------- | ---- | ---- | ----------------- | ----------------------------- |
| id          | bigint unsigned | -    | YES  | AUTO_INCREMENT    | 用户ID，主键                  |
| name        | varchar         | 255  | YES  | ''                | 用户姓名                      |
| gender      | tinyint         | 3    | YES  | 0                 | 用户性别 (0:未知, 1:男, 2:女) |
| mobile      | varchar         | 255  | YES  | ''                | 用户手机号，唯一索引          |
| password    | varchar         | 255  | YES  | ''                | 用户密码 (加密存储)           |
| create_time | timestamp       | -    | NO   | CURRENT_TIMESTAMP | 创建时间                      |
| update_time | timestamp       | -    | NO   | CURRENT_TIMESTAMP | 更新时间                      |

### 2.2 索引设计

- **主键**: `PRIMARY KEY (id)`
- **唯一索引**: `UNIQUE KEY idx_mobile_unique (mobile)` - 保证手机号唯一性

## 3. 功能接口说明

### 3.1 用户登录

**功能描述**: 用户通过手机号和密码进行登录认证

- **请求方式**: `POST`
- **请求路径**: `/api/user/login`

**业务参数**:
```json
{
  "mobile": "13800138000",     // 手机号，必填
  "password": "123456"         // 密码，必填
}
```

**返回信息**:
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 访问令牌
  "accessExpire": 1627776000   // 令牌过期时间戳
}
```

### 3.2 用户注册

**功能描述**: 新用户注册账号

- **请求方式**: `POST`
- **请求路径**: `/api/user/register`

**业务参数**:
```json
{
  "name": "张三",              // 用户姓名，必填
  "gender": 1,                // 用户性别，必填 (0:未知, 1:男, 2:女)
  "mobile": "13800138000",    // 手机号，必填，需唯一
  "password": "123456"        // 密码，必填
}
```

**返回信息**:
```json
{
  "id": 1001,                 // 用户ID
  "name": "张三",              // 用户姓名
  "gender": 1,                // 用户性别
  "mobile": "13800138000"     // 手机号
}
```

### 3.3 获取用户信息

**功能描述**: 获取当前登录用户的个人信息

- **请求方式**: `POST`
- **请求路径**: `/api/user/userinfo`

**业务参数**: 无需请求体（用户ID从登录令牌中获取）

**返回信息**:
```json
{
  "id": 1001,                 // 用户ID
  "name": "张三",              // 用户姓名
  "gender": 1,                // 用户性别
  "mobile": "13800138000"     // 手机号
}
```

### 3.4 更新用户信息

**功能描述**: 更新用户的个人信息

- **请求方式**: `POST` (通过 gRPC 调用)

**业务参数**:
```json
{
  "id": 1001,                 // 用户ID，必填
  "name": "李四",              // 用户姓名，可选更新
  "gender": 2,                // 用户性别，可选更新
  "mobile": "13900139000"     // 手机号，可选更新
}
```

**返回信息**:
```json
{
  "id": 1001,                 // 用户ID
  "name": "李四",              // 更新后的用户姓名
  "gender": 2,                // 更新后的用户性别
  "mobile": "13900139000"     // 更新后的手机号
}
```

## 4. 业务规则说明

### 4.1 用户注册规则

1. 用户姓名不能为空，长度限制在255个字符内
2. 手机号必须唯一，不允许重复注册
3. 密码需要进行加密存储，不以明文保存
4. 性别字段：0表示未知，1表示男性，2表示女性
5. 注册成功后返回用户基本信息，但不包含密码

### 4.2 用户登录规则

1. 使用手机号和密码进行身份验证
2. 手机号必须是已注册的有效账号
3. 密码验证通过后生成访问令牌
4. 令牌具有有效期限制，过期后需重新登录
5. 登录成功返回令牌和过期时间

### 4.3 用户信息访问规则

1. 获取用户信息需要有效的登录令牌
2. 只能查看当前登录用户的个人信息
3. 返回的信息不包含密码等敏感数据
4. 用户信息包括：ID、姓名、性别、手机号

### 4.4 用户信息更新规则

1. 支持部分字段更新，包括姓名、性别、手机号
2. 如果更新手机号，新手机号必须保证唯一性
3. 更新后返回完整的用户信息
4. 密码更新需要通过专门的密码修改接口（暂未实现）

## 5. 错误处理说明

| 错误码 | 错误信息              | 业务场景                       |
| ------ | --------------------- | ------------------------------ |
| 200    | Success               | 操作成功                       |
| 400    | Bad Request           | 请求参数格式错误或缺少必填字段 |
| 401    | Unauthorized          | 登录令牌无效或已过期           |
| 409    | Conflict              | 手机号已被其他用户注册         |
| 500    | Internal Server Error | 系统内部错误                   |

## 6. 数据字段说明

### 6.1 性别字段取值

- **0**: 未知/不愿透露
- **1**: 男性  
- **2**: 女性

### 6.2 时间字段

- **create_time**: 账号创建时间，自动生成
- **update_time**: 信息最后更新时间，自动更新

---

**文档版本**: v1.0  
**最后更新**: 2025年7月27日